rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isUserOfHotel(hotelId) {
      return exists(/databases/$(database)/documents/hotels/$(hotelId)/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/hotels/$(hotelId)/users/$(request.auth.uid)).data.status == 'active';
    }

    function isAdminOfHotel(hotelId) {
      return isUserOfHotel(hotelId) &&
             get(/databases/$(database)/documents/hotels/$(hotelId)/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /hotels/{hotelId} {
      allow read: if isUserOfHotel(hotelId);
      
      // All users can see the user list, but only admins can modify it (see below)
      match /users/{userId} {
        allow read: if isUserOfHotel(hotelId);

        // Allow a user to create their own 'pending' request
        allow create: if request.auth.uid == userId &&
                         request.resource.data.status == 'pending' &&
                         request.resource.data.role == 'member';
                         
        // Allow an admin to update or delete any user
        allow update, delete: if isAdminOfHotel(hotelId);
      }
      
      match /partners/{partnerId} {
        allow read: if isUserOfHotel(hotelId);
        allow write: if isAdminOfHotel(hotelId);
        
        match /periodHistory/{historyId} {
           allow read: if isUserOfHotel(hotelId);
           allow write: if isAdminOfHotel(hotelId);
        }
      }
      
      match /clients/{clientId} {
         allow read: if isUserOfHotel(hotelId);
         allow write: if isAdminOfHotel(hotelId);
      }
      
      match /transactions/{transactionId} {
        allow read: if isUserOfHotel(hotelId);
        // Only admins can delete transactions, but all authenticated users can create/update (flag)
        allow create, update: if isUserOfHotel(hotelId);
        allow delete: if isAdminOfHotel(hotelId);
      }
    }
  }
}
